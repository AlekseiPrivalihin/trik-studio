<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="TRIKStudio, help, manual, user guide" />
<meta name="description" content="TRIKStudio help center" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Программирование ТРИК в TRIKStudio</title>
<link href="style.css" rel="stylesheet" type="text/css" media="screen" />
<script type="text/javascript" src="version.js"></script>
</head>

<!-- TODO: move contents, header and footer into common separate files -->
<body>
<div id="wrapper">
	<script type="text/javascript" src="header.html.js"></script>
	<div id="page" class="container">
		<div id="sidebar">
			<script type="text/javascript" src="contents.html.js"></script>
		</div>		
		<div id="content">
			<div class="post">
				<h2 class="title">Программирование контроллера ТРИК в TRIKStudio<a href="#"></a></h2>
				<div class="entry">
					<p></p>
				</div>
			</div>
			
			<h3><a name="connection">Подключение робота</a></h3>

			<p>
			Подробная инструкция по настройке и подключению робота к сети находится на вики проекта, <a href="https://github.com/trikset/trikRuntime/wiki/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%86%D0%B8%D1%8F-%D0%BF%D0%BE-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B5-%D0%B8-%D0%BF%D0%BE%D0%B4%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D1%8E-%D0%BA-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D1%83">Инструкция по настройке и подсоединению к контроллеру</a>. Здесь будем считать, что робот и компьютер с TRIKStudio уже находятся в одной сети. В таком случае достаточно выбрать конструктор ТРИК в окне настроек и указать IP-адрес робота (его можно посмотреть в меню "Сеть" на роботе):
			</p>
			
			<center><img src="pics/trik-kit-selection.png" alt="Выбор конструктора ТРИК" width="660"></center>
			
			<p> 
			Указать IP-адрес робота можно и в окне конфигурации сенсоров прямо на главном окне TRIKStudio:
			</p>

			<center><img src="pics/trik-fast-ip-selection.png" alt="Быстрый выбор IP-адреса"></center>

			<p> 
			Этих действий достаточно для работы с ТРИК в режиме генерации, для работы интерпретатора необходимо ещё установить соединение с роботом, нажав на кнопку "Подключиться" на панели инструментов:
			</p>

			<center><img src="pics/trik-connect.png" alt="Кнопка 'Подключиться'" width="660"></center>
			
			<h3><a name="blocks">Блоки ТРИК</a></h3>
			
			<p>
			Специализированные блоки для ТРИК делятся на несколько категорий:
			</p>

			<ul>
				<li><b><a href="#trik-functional-blocks">Действия</a></b> – блоки, выполняющие какое-либо действие на роботе: включение моторов, проигрывание звука и т.д.</li>
				<li><b><a href="#trik-waiting-blocks">Ожидания</a></b> – блоки, ждущие наступления какого-либо события: определённых показаний датчиков, нажатия на кнопку и т.д.</li> 
				<li><b><a href="#trik-drawing-blocks">Рисования на дисплее</a></b> – блоки, используемые для вывода графики и текста на экран.</li>
			</ul>

			<h4><a name="trik-functional-blocks">Действия</a></h4>

			<table cellspacing="2" border="1" cellpadding="5" width="800" >
				<tr>
					<td><b>Название элемента</b></td>
					<td><b>Пиктограмма</b></td>
					<td><b>Описание</b></td>
				</tr>
				<tr>
					<td>Играть звук</td>
					<td><center><img src="pics/trik-playSoundBlock.png" alt="Гудок"></center></td>
					<td>Проиграть на роботе заданный звуковой файл, который должен быть заранее загружен на робот. Путь до файла указывается относительно папки trik на роботе. Загрузить файл на робот можно, например, с помощью программы <a href="http://winscp.net/eng/docs/lang:ru">WinSCP</a></td>
				</tr>
				<tr>
					<td>Моторы вперёд</td>
					<td><center><img src="pics/trik-enginesForwardBlock.png" alt="Моторы вперёд"></center></td>
					<td>Включить моторы по заданным портам с заданной мощностью. Порты задаются строками M1, M2, M3 и M4, разделенными запятыми. Мощность задается в процентах числом от -100 до 100, если задано отрицательное значение, мотор включается в режиме реверса. Так, на картинке изображена команда включения моторов на портах M3 и M4 с мощностью 100%.
					</td>
				</tr>
				<tr>
					<td>Моторы назад</td>
					<td><center><img src="pics/trik-enginesBackwardBlock.png" alt="Моторы назад"></center></td>
					<td>Включить моторы в режиме реверса по заданным портам с заданной мощностью. Параметры аналогичны параметрами блока "Моторы вперёд".</td>
				</tr>




				
				<tr>
					<td>Моторы вперёд</td>
					<td><center><img src="pics/nxt-enginesForwardBlock.png" alt="Моторы вперёд"></center></td>
					<td>Включить моторы по заданным портам с заданной мощностью. Порты задаются буквами A, B или C, разделенными запятыми. Мощность задается в процентах числом от -100 до 100, если задано отрицательное значение, мотор включается в режиме реверса. Так, на картинке изображена команда включения моторов на портах A и B с мощностью 100%. Кроме того, моторы имеют разные режимы работы: режим торможения и режим скольжения (отображаемые красным или зелёным прямоугольником на блоке соответственно). Режимы влияют на то, как двигатель отрабатывает команду — режим торможения стопорит двигатель при отключении, режим скольжения позволяет двигателю прокручиваться по инерции. 
					</td>
				</tr>
				<tr>
					<td>Моторы назад</td>
					<td><center><img src="pics/nxt-enginesBackwardBlock.png" alt="Моторы назад"></center></td>
					<td>Включить моторы в режиме реверса по заданным портам с заданной мощностью. Параметры аналогичны параметрами блока "Моторы вперёд".</td>
				</tr>
				<tr>
					<td>Моторы стоп</td>
					<td><center><img src="pics/nxt-enginesStopBlock.png" alt="Моторы стоп"></center></td>
					<td>Выключить моторы по заданным портам.</td>
				</tr>
				<tr>
					<td>Сбросить показания энкодера</td>
					<td><center><img src="pics/nxt-clearEncoderBlock.png" alt="Сбросить показания энкодера"></center></td>
					<td>Сбросить показания количества оборотов моторов.</td>
				</tr>
			</table>

			<br/>

			<h4><a name="trik-waiting-blocks">Ожидания</a></h4>

			<table cellspacing="2" border="1" cellpadding="5" width="800" >
				<tr>
					<td><b>Название элемента</b></td>
					<td><b>Пиктограмма</b></td>
					<td><b>Описание</b></td>
				</tr>
				<tr>
					<td>Ждать сенсор касания</td>
					<td><center><img src="pics/nxt-waitTouchBlock.png" alt="Ждать сенсор касания"></center></td>
					<td>Ждать, пока не сработает датчик касания. Параметром указывается номер порта, к которому подключен датчик. Допустимые значения: 1, 2, 3, 4.</td>
				</tr>
				<tr>
					<td>Ждать сонар</td>
					<td><center><img src="pics/nxt-waitSonarBlock.png" alt="Ждать сонар"></center></td>
					<td>Ждать, пока расстояние, возвращаемое ультразвуковым сенсором расстояния, не будет сравнимо с указанным в значении параметра "Расстояние" (расстояние задается в сантиметрах, от 0 до 255). Еще один парамер — номер порта, к которому подключен датчик расстояния. Также параметром указывается операция, которая будет использоваться для сравнения с введенным расстоянием. Так, при выполнении приведенного блока выполнение программы остановится до тех пор, пока значение, возвращаемое сонаром, не будет больше, чем 40 см.</td>
				</tr>
				<tr>
					<td>Ждать цвет</td>
					<td><center><img src="pics/nxt-waitColorBlock.png" alt="Ждать цвет"></center></td>
					<td>Ждать, пока сенсор цвета в режиме распознавания цветов не вернет указанный цвет.</td>
				</tr>
				<tr>
					<td>Ждать энкодер</td>
					<td><center><img src="pics/nxt-waitEncoderBlock.png" alt="Ждать энкодер"></center></td>
					<td>Ждать, пока показания счетчика количества оборотов на заданном моторе не достинут указанного в значении параметра "Предел оборотов".</td>
				</tr>
				<tr>
					<td>Ждать интенсивность цвета</td>
					<td><center><img src="pics/nxt-waitIntensityBlock.png" alt="Ждать интенсивность цвета"></center></td>
					<td>Ждать, пока значение, возвращаемое сенсором цвета на указанном порту, не будет сравнимо с указанным в значении параметра "Интенсивность" (задается в процентах). Еще один парамер — номер порта, к которому подключен сенсор цвета. Также параметром указывается операция, которая будет использоваться для сравнения с введенной интенсивностью. Так, при выполнении приведенного блока выполнение программы остановится до тех пор, пока значение, возвращаемое соответствующим сенсором цвета, не будет больше, чем 60 процентов.</td>
				</tr>
				<tr>
					<td>Ждать свет</td>
					<td><center><img src="pics/nxt-waitLightBlock.png" alt="Ждать свет"></center></td>
					<td>Ждать, пока значение, возвращаемое сенсором света на указанном порту, не будет сравнимо с указанным в значении параметра "Проценты". Еще один парамер — номер порта, к которому подключен сенсор цвета. Также параметром указывается операция, которая будет использоваться для сравнения со значением параметра "Проценты". Так, при выполнении приведенного блока выполнение программы остановится до тех пор, пока значение, возвращаемое соответствующим сенсором света, не будет больше, чем 60 процентов.</td>
				</tr>
				<tr>
					<td>Ждать сенсор звука</td>
					<td><center><img src="pics/nxt-waitSoundBlock.png" alt="Ждать сенсор звука"></center></td>
					<td>Ждать, пока громкость, считанная микрофоном на заданном порту, не будет выше или ниже заданного значения.</td>
				</tr>
				<tr>
					<td>Ждать нажатия кнопки "Ввод"</td>
					<td><center><img src="pics/nxt-waitForEnterBlock.png" alt="Ждать нажатия кнопки Ввод"></center></td>
					<td>Ждать, пока не будет нажата кнопка "Ввод" (оранжевая) на корпусе робота.</td>
				</tr>
				<tr>
					<td>Ждать нажатия кнопки "Отмена"</td>
					<td><center><img src="pics/nxt-waitForEscapeBlock.png" alt="Ждать нажатия кнопки Отмена"></center></td>
					<td>Ждать, пока не будет нажата кнопка "Отмена" (серая) на корпусе робота.</td>
				</tr>
				<tr>
					<td>Ждать нажатия кнопки "Влево"</td>
					<td><center><img src="pics/nxt-waitForLeftBlock.png" alt="Ждать нажатия кнопки Влево"></center></td>
					<td>Ждать, пока не будет нажата кнопка "Влево" на корпусе робота.</td>
				</tr>
				<tr>
					<td>Ждать нажатия кнопки "Вправо"</td>
					<td><center><img src="pics/nxt-waitForRightBlock.png" alt="Ждать нажатия кнопки Вправо"></center></td>
					<td>Ждать, пока не будет нажата кнопка "Вправо" на корпусе робота.</td>
				</tr>
			</table>

			<br/>

			<h4><a name="trik-drawing-blocks">Рисование на дисплее</a></h4>
			
			<p>
			Блоки рисования на дисплее работают только при прошивке программы на робот или в двумерной модели, при интерпретации программы по Bluetooth или USB они работать не будут в силу ограничений в системе прямых команд робота.
			</p>

			<table cellspacing="2" border="1" cellpadding="5" width="800" >
				<tr>
					<td><b>Название элемента</b></td>
					<td><b>Пиктограмма</b></td>
					<td><b>Описание</b></td>
				</tr>
				<tr>
					<td>Нарисовать прямоугольник</td>
					<td><center><img src="pics/nxt-drawRectangleBlock.png" alt="Нарисовать прямоугольник"></center></td>
					<td>Нарисовать на экране прямоугольник. В качестве параметров указываются координаты левого верхнего угла, ширина и высота прямоугольника.</td>
				</tr>
				<tr>
					<td>Нарисовать точку</td>
					<td><center><img src="pics/nxt-drawPointBlock.png" alt="Нарисовать точку"></center></td>
					<td>Нарисовать на экране точку в указанных координатах.</td>
				</tr>
				<tr>
					<td>Нарисовать линию</td>
					<td><center><img src="pics/nxt-drawLineBlock.png" alt="Нарисовать линию"></center></td>
					<td>Нарисовать на экране отрезок. В качестве параметров блоку указываются концы отрезка.</td>
				</tr>
				<tr>
					<td>Нарисовать круг</td>
					<td><center><img src="pics/nxt-drawCircleBlock.png" alt="Нарисовать круг"></center></td>
					<td>Нарисовать на экране круг с заданным центром и заданным радиусом.</td>
				</tr>
				<tr>
					<td>Напечатать текст</td>
					<td><center><img src="pics/nxt-displayTextBlock.png" alt="Напечатать текст"></center></td>
					<td>Напечатать заданное значение в заданных координатах на экране. Обратите внимание, что напечатается результат вычисления выражения, поэтому строки, которые нужно вывести на экран, надо заключать в кавычки.</td>
				</tr>
				<tr>
					<td>Очистить экран</td>
					<td><center><img src="pics/nxt-clearScreenBlock.png" alt="Очистить экран"></center></td>
					<td>Стереть всё, что нарисовано на экране.</td>
				</tr>
			</table>

			<p>
			Описание блоков, общих для всех конструкторов, можно посмотреть в разделе <a href="programming.html#blocks">Создание программ/Создание блоков</a>.
			</p>

			<h3><a name="textual-programming">Текстовое программирование</a></h3>
			
			<p>
			Текстовое программирование для Lego NXT осуществляется на языке C с использованием макросов и функций из библиотеки ECRobot. Общая структура программы такова:
			<ul>
				<li>Сначала идёт подключение заголовочных файлов, используемых в программе (стандартные заголовочные файлы C и заголовочные файлы ECRobot)</li>
				<li>Затем идёт объявление констант и переменных, используемых в программе</li>
				<li>За ними описываются функции ecrobot_device_initialize и ecrobot_device_terminate, первая вызывается при запуске программы, вторая - при прекращении её работы. В них обычно выполняется инициализация и деинициализация датчиков, энкодеров и других устройств робота. По умолчанию в ecrobot_device_initialize инициализируется генератор случайных чисел.</li>
				<li>За ними идёт описание функции user_1ms_isr_type2, которая вызывается каждую миллисекунду.</li>
				<li>Затем идёт описание задачи, которая запускается на исполнение при старте программы: TASK(OSEK_Task_Number_0). Здесь, собственно, и выполняется большая часть программирования.</li>
			</ul>
			</p>
			
			<p>
			Пример пустой, но содержащей все необходимые разделы программы приведён ниже:
			</p>
			
			<pre>
#include &lt;string.h>
#include "kernel.h"
#include "kernel_id.h"
#include "ecrobot_interface.h"
#include "trik_studio_utils.h"
#include &lt;time.h>
#include &lt;stdlib.h>
#include &lt;stdio.h>
#include &lt;stdarg.h>
#include &lt;math.h>

U32 __interpretation_started_timestamp__ = 0;
static const float pi = 3.14159265;



void ecrobot_device_initialize(void)
{
	srand(systick_get_ms());

}

void ecrobot_device_terminate(void)
{

}

/* nxtOSEK hook to be invoked from an ISR in category 2 */
void user_1ms_isr_type2(void)
{ 

}

/* Main task */
TASK(TASK_MAIN)
{
	__interpretation_started_timestamp__ = systick_get_ms();

	TerminateTask();
}
			</pre>
			
			<p>
			Полное описание (на английском) функций, доступных при программировании доступно по ссылке <a href="http://lejos-osek.sourceforge.net/api.htm">http://lejos-osek.sourceforge.net/api.htm</a>. См. также <a href="http://lejos-osek.sourceforge.net/index.htm">http://lejos-osek.sourceforge.net/index.htm</a>. В качестве примеров можно использовать код, генерируемый по диаграммам самой средой TRIKStudio.
			</p>
			
			<h3><a name="run-programs">Запуск программ</a></h3>
			
			<p>
			Для Lego NXT существует несколько вариантов выполнения программ: 
			<ul>
			  <li>пошаговая интерпретация диаграммы с посылкой команд в робота по Bluetooth или USB, или моделированием поведения робота с помощью двумерной модели</li>
			  <li>прошивка и дальнейшее автономное исполнение программы на роботе без связи с компьютером.</li>
			</ul>
			</p>

			<h4><a name="run-programs-bluetooth">Интерпретация по Bluetooth</a></h3>

			<p>
			Чтобы запустить программу на выполнение, необходимо нажать кнопку "Выполнить" панели "Интерпретатор" или меню "Инструменты":
			</p>

			<center><img src="pics/nxt-execute-toolbar.png" alt="Запуск программы"></center>

			<p>
			После этого интерпретатор ищет блок "Начало", с которого и начинается выполнение программы. Если такой блок на диаграмме не найден, будет выдано сообщение об ошибке. Для каждого функционального блока должна существовать ровно одна исходящая связь, по которой выполнение программы перейдет к следующему блоку. В противном случае будет выдано сообщение об ошибке.
			</p>

			<p>
			Для того, чтобы остановить выполнение программы, нужно нажать кнопку "Прервать выполнение" панели "Интерпретатор" или меню "Инструменты":
			</p>
			
			<center><img src="pics/nxt-stop-interpreter.png" alt="Остановка программы"></center>

			<br />
			<h4><a name="run-programs-flashing">Прошивка в робота</a></h3>

			<p>
			Для прошивки программ в робота в TRIKStudio необходим дополнительный пакет инструментов, называемый NXTTools. Его может быть нужно доустановить с помощью менеджера пакетов (TRIKStudio/maintenance.exe), если он не был установлен изначально. Наличие NXTTools можно проверить по наличию кнопок "Генерировать код", "Прошить" и "Загрузить программу" на панели инструментов. Если кнопки есть, NXTTools установлен, если нет, загружать программу на робот нельзя:
			</p>
			
			<center><img src="pics/nxt-flash-toolbar.png" alt="Прошивка робота"></center>

			<p>
			Для того, чтобы запускать программы на роботе, вместо стандартной операционной системы Lego Mindstorms NXT 2.0 необходимо использовать прошивку nxtOSEK, которая является расширением стандартной системы, позволяющим сохранять программы с компьютера по USB и запускать их на роботе. Чтобы записать в робота прошивку nxtOSEK, необходимо подключить его по USB к компьютеру, перевести робота в режим перезагрузки (нажать и удерживать 4 секунды кнопку Reset на задней панели управляющего блока робота) и нажать в TRIKStudio кнопку "Прошить" панели инструментов "Взаимодействие с роботом":
			</p>

			<center><img src="pics/nxt-upload-osek-toolbar.png" alt="Кнопка 'Прошить'"></center>

			<p>
			Дождитесь информационного сообщения, подтверждающего завершение операции прошивки операционной системы. В случае неуспешного завершения убедитесь, что робот корректно подключен к компьютеру с помощью USB-провода и находится в режиме перезагрузки, после чего попробуйте перезаписать образ операционной системы еще раз.
			</p>

			
			<p>
			Когда прошивка успешно перезаписана, робот готов к загрузке на него и выполнению программ. Для этого нужно убедиться, что робот корректно подключен по USB к компьютеру и находится во включенном состоянии. После этого нужно нажать кнопку "Загрузить" панели инструментов "Взаимодействие с роботом". В редакторе диаграмм откроется дополнительная вкладка, на которой будет показан код на Си-подобном языке, поддерживаемом операционной системой nxtOSEK. Этот код будет скомпилирован в исполняемую программу и загружен в робота. При неудачном завершении операции будет выдано информационное сообщение, описывающее проблему.
			</p>
		</div>
		<!-- end #content -->
		<div style="clear: both;">&nbsp;</div>
	</div>
	<!-- end #page -->
</div>
<script type="text/javascript" src="footer.html.js"></script>
</body>
</html>
